# 鉴权

鉴权是由`permmison`文件进行控制的。

## `vue-element-admin`鉴权流程

设置一个白名单数组，将不需要权限访问的路由存入其中

设置路由导航

先判断是否有token？

* 没有token ,判断访问页面是否在白名单内？
  * 如果没有在白名单内，跳转到登录页面
  * 如果在白名单内，跳转到需要访问的页面
* 有token，判断访问页面是否是登录页面？
  * 是登录页面，跳转到首页
  * 不是登录页面，判断是否有用户信息？
    * 有用户信息，跳转到需要访问的页面、
    * 没有用户信息，从token中能否获取用户信息？
      * 能获取用户信息成功，跳转到需要访问的页面
      * 能获取用户信息失败，重置token,跳转到登录页面

流程图：



## 修改后的鉴权流程

在路由配置文件中，为需要鉴权的路由的meta属性中添加`auth：true`。

设置路由导航



先[判断是否需要权限](#判断是否需要权限)？

* 不需要权限，[判断是否访问login页面](#判断是否访问login页面)？
  * 不是login页面，跳转到需要访问的页面
  * 是login页面，[判断是否已经登录](#判断是否已经登录/判断是否有用户信息)？
    * 已经登录，跳转到首页
    * 没有登录，跳转到登录页面
* 需要权限，[判断是否有用户信息](#判断是否已经登录/判断是否有用户信息)？
  * 有用户信息，跳转到需要访问的页面
  * 没有用户信息，[判断是否有token](#判断是否有token)？
    * 没有token，跳转到登录页面
    * 有token，[判断是否能从token中获取用户信息](#判断是否能从token中获取用户信息)？
      * 能获取用户信息，跳转到需要访问的页面
      * 不能获取用户信息，重置token，跳转到登录页面

流程图：

### 判断是否需要权限

从路由的额外信息中获取,即meta中是否有`auth:true`。

```javascript
if(to.meta.auth){
//进入此判断说明访问该页面需要权限
}else{
//进入此判断说明访问该页面不需要权限
}
```

### 判断是否访问login页面

```javascript
if(to.path==='/login'){
//进入此判断说明访问该页面为登陆页面
}else{
//进入此判断说明访问该页面不为登录页面
}
```

### 判断是否已经登录/判断是否有用户信息

```javascript
const hasGetUserInfo = store.getters.user;//获取仓库中用户信息
if(hasGetUserInfo){
//进入此判断说明之前已经登陆过/仓库中已有用户信息
}else{
//进入此判断说明之前没有登录过/仓库中没有用户信息
}
```

### 判断是否有token

```javascript
const hasToken = localStorege.getItem('TOKEN');
if( hasToken){
//进入此判断说明本地有token
}else{
//进入此判断说明本地没有token
}
```

### 判断是否能从token中获取用户信息

```javascript
try{
//需要发送网络请求，根据token获取用户信息。这里选择通过在仓库user中通过分发getinfo操作来调用发送网络请求的方法
	await  store.dispatch(user/getInfo)
}catch(error){
//如果不能获取到用户信息，则需要重置token
	await store.diaptch(user/resetToken)
}
```

## 发送请求恢复登录（根据token，获取用户信息）

#### `api`文件中配置恢复请求方法(`getInfo`)

#### `request`文件中拦截并添加请求头

#### `store/user`文件中调用恢复请求方法，配置action

响应数据类型为字符串，说明未登录或者token已过期，Promise失败,返回失败的msg。

响应数据不为字符串，说明可以获取用户信息，并将用户信息放入仓库,Promise成功。

## 重置token

## 退出登录

修改页面的退出样式和内容

实现退出登录功能
