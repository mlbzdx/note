上一章节的课程进行书写了登录页面并进行了前端验证。

## 1. 注册登录事件

### （1）添加加载中效果

点击登录按钮后，登录按钮显示加载中的效果，通过设置loading来实现。

### （2）调用表单验证方法（前端验证）

在`vue-element-admin`的验证表单中，验证的结果（一个布尔值）会以参数的形式传入到验证方法（函数）中，该方法即`loginForm`的`validate`方法在需要进行前端验证时可以调用验证表单该方法进行验证。

例，在用户点击登录按钮后，会对填写的表单内容的格式、长度等进行前端验证。此时，只需在用户点击事件中调用验证方法，就能进行验证通过或者未通过的后续操作了。

```javascript
handlelogin(){
//调用验证方法
	his.$refs.loginForm.validate((valid) => {
        if (valid) {
        //验证通过，可以进行发送登录请求，进行服务器后端验证等后续操作
        }
        //未通过验证，可以进行弹出提示框，告知用户登录账号、密码或者验证码的格式不正确等操作。
      }
}
```

## 2. 发送登录网络请求，进行后端验证

### （1）查看接口文档，完善请求数据

* 查看接口文档中的登录的请求方法，请求路径，请求头和请求体配置。
* 我们需要配置的登录请求体数据也即是用户所需要填写的账号、密码、验证码等信息，这些数据保存在login单文件组件的data中，但是与接口文档相比较缺少了remember属性，其值由7天免登录是否勾选所决定，在配置请求之前需要添加好这一项。

### （2）发送网络请求，配置请求代理

* 请求时，`vue-element-admin`已经为我们创建好了`axios`的请求实例方法`request`，直接调用该方法，传入参数即可,如果在发送请求前想要修改默认的请求拦截，可以在`utils/request.js`文件中进行配置。
* 填写好请求路径后，在开发时因为跨域问题存在，还需要在`vue.config.js`中配置请求代理。
* 书写好请求方法后，不直接在登录事件函数中进行调用，而是通过创建仓库，在仓库中通过分发操作调用请求方法，这样做便于保存请求发出后响应的数据。

### （3）接受响应数据，根据数据类型分情况处理

#### 测试查看响应结果：

* 当出现验证码填错情况时，返回的数据类型是字符串
* 当正确填写了验证码，但账号密码与后端服务器验证不匹配时，返回的数据类型是一个对象，data的值为null
* 当正确填写所有信息后，返回的数据类型是一个对象，data的值为你的账号密码等信息。

#### 返回Promise

因为要根据响应的数据进行判定并进行任务分配，可以返回new Promise来判断请求任务是否执行成功。

对接受到的响应数据首先进行结构，判断data是否有数据，有数据的情况即信息填写正确。

如果data没有数据时，返回响应数据，任务失败/如果没有接受到响应数据或者响应数据为字符串时，返回响应数据，任务失败。

#### 保存响应数据

##### 存储响应体数据

当成功获取响应数据（用户信息）后，在分发中调用commit将数据保存在仓库的state中。

##### 存储响应头数据

拦截登录响应头数据，本地存储token

拦截请求头需要在`utils/request.js`文件中进行配置。

如果请求头对象有authentication这个属性，就将其值本地保存在`localstorage`中（即token），后面进行其他请求时将其加入请求头带到服务器。

#### 处理异步分发

> 异步分发请求失败，判断失败原因，弹出弹框，提示错误消息，清空用户填写的错误内容，更新页面验证码，移除登录按钮的加载中状态。

* 如果异步分发获取的响应数据类型为字符串，说明验证码填写错误。

  此时，弹出弹窗，提示用户验证码填写错误，并清空用户填写的验证码。

* 如果异步分发获取的响应数据类型不为字符串，说明用户填写的账号密码错误。

  此时，弹出弹窗，提示用户账号密码填写错误，并清空用户在表单上的所有信息。

* 之后调用请求方法重新获取并更新页面的验证码，将登录按钮的加载中效果移除。

> 异步分发请求成功获取数据，

* 进行页面鉴权，鉴权之后进行页面跳转
* 移除登录按钮加载中状态



遇到的问题：

* 表单数据与组件数据的绑定

  

